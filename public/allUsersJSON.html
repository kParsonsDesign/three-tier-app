<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Three Tier - Week 22</title>

  <!-- Bootstrap CSS only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">

  <!-- Superagent - small, client-side HTTP request library -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=WeakRef,BigInt"></script>
  <script src="https://cdn.jsdelivr.net/npm/superagent"></script>

  <!-- Add External HTML Files -->
  <script>
    function includeHTML() {
      var z, i, elmnt, file, xhttp;
      /* Loop through a collection of all HTML elements: */
      z = document.getElementsByTagName("*");
      for (i = 0; i < z.length; i++) {
        elmnt = z[i];
        /*search for elements with a certain atrribute:*/
        file = elmnt.getAttribute("w3-include-html");
        if (file) {
          /* Make an HTTP request using the attribute value as the file name: */
          xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4) {
              if (this.status == 200) {elmnt.innerHTML = this.responseText;}
              if (this.status == 404) {elmnt.innerHTML = "Page not found.";}
              /* Remove the attribute, and call this function once more: */
              elmnt.removeAttribute("w3-include-html");
              includeHTML();
            }
          }
          xhttp.open("GET", file, true);
          xhttp.send();
          /* Exit the function: */
          return;
        }
      }
    }
  </script>

  <link rel="stylesheet" href="style.css">
  <style>
    /* styles for responsive data container this page only */
    body{position: fixed;top:0;bottom: 0;width: 100%;height: 100%;}
    main{display:flex; flex-direction:column; height:calc(100% - 4rem)}
  </style>
</head>
<body>
  <div w3-include-html="nav.html" class="bg-light" style="width:100%; min-height:3rem"></div>

  <main role="main" class="container-lg mt-3">
    <h1 class="fw-light" style="flex-grow: 2;">All Users - JSON</h1>
    <div class="border rounded p-2 userdata">
      <pre id="allUsers"></pre>
    </div>
  </main>
  
  
</body>
<!-- Include External HTML Files -->
<script>
  includeHTML();
</script>

<script>
  function users() {
    const users = document.getElementById('users');
    const allUsersUrl = '/users';
    const usersDiv = document.getElementById('allUsers')

    superagent
      .get(allUsersUrl)
      .end((err, res) => {
        if (err) {
          console.log(err)
        } else {
          let allUsers = res.body
          if (allUsers) {
            if (usersDiv.innerHTML !== '') usersDiv.innerHTML = ''
            console.log(allUsers)
            let allData = JSON.stringify(allUsers, null, 2)
            // allData = allData.replace(/\{/g, "\n  {\n    ")
            // allData = allData.replace(/(?<!\})\,/g, "\,\n    ")
            // allData = allData.replace(/\}/g, "\n  }")
            // allData = allData.replace(/\]/g, "\n]")
            allData = allData.replace(/^( *)("[\w]+": )?("[^"]*"|[\w.+-]*)?([,[{])?$/mg, replacer)
            allData = allData.replace(/(?<=\"\w{1,8}\")\: /g, ':\t\t')
            allData = allData.replace(/(?<=\"\w{9,}\")\: /g, ':\t')
            usersDiv.innerHTML = allData
          } else {
            usersDiv.appendChild('<h3>No Users</h3>')
          }
        }
      })
  }
  users()

  const replacer = function(match, indent, key, val, end) {
    const keyPrfx = '<span class=json-key>'
    const valPrfx = '<span class=json-value>'
    const strPrfx = '<span class=json-string>'
    let r = indent || ''
    if(key)
      r = r + keyPrfx + key + '</span>'
    if(val)
      r = r + (val[0] === '"' ? strPrfx : valPrfx) + val + '</span>'
    return r + (end || '')
  }
</script>

<!-- Bootstrap JavaScript Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
</html>
